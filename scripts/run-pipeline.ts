/**
 * íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸
 *
 * Weekly Summary íŒŒì´í”„ë¼ì¸ì„ ì‹¤í–‰í•˜ì—¬ ì£¼ê°„ ë¦¬í¬íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
 *
 * ì‹¤í–‰: npx ts-node scripts/run-pipeline.ts
 * ë˜ëŠ”: npm run pipeline:weekly
 */

import * as fs from "fs";
import * as path from "path";

// ===== ì„¤ì • =====
const CONFIG = {
  pipelineName: "weekly-summary",
  outputDir: path.join(__dirname, "..", "reports", "weekly"),
  templatesDir: path.join(__dirname, "..", "reports", "templates"),
  agentsDir: path.join(__dirname, "..", "claude", "agents"),
};

// ===== íƒ€ì… ì •ì˜ =====
interface PipelineInput {
  conversations: string;
  dateRange: {
    start: string;
    end: string;
  };
  team?: string;
}

interface SummaryResult {
  highlights: string[];
  projectStatus: Array<{
    project: string;
    status: string;
    progress: number;
  }>;
  nextWeek: string[];
}

interface Decision {
  id: number;
  content: string;
  participants: string[];
  impact: "high" | "medium" | "low";
}

interface ActionItem {
  id: number;
  task: string;
  assignee: string | null;
  deadline: string | null;
  priority: "high" | "medium" | "low";
}

interface PipelineOutput {
  summary: SummaryResult;
  decisions: Decision[];
  actions: ActionItem[];
  generatedAt: string;
}

// ===== ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ =====
function getDateString(): string {
  return new Date().toISOString().split("T")[0];
}

function getWeekRange(): { start: string; end: string } {
  const now = new Date();
  const dayOfWeek = now.getDay();
  const start = new Date(now);
  start.setDate(now.getDate() - dayOfWeek - 6); // ì§€ë‚œ ì£¼ ì›”ìš”ì¼
  const end = new Date(now);
  end.setDate(now.getDate() - dayOfWeek); // ì§€ë‚œ ì£¼ ì¼ìš”ì¼

  return {
    start: start.toISOString().split("T")[0],
    end: end.toISOString().split("T")[0],
  };
}

// ===== ì—ì´ì „íŠ¸ ì‹¤í–‰ í•¨ìˆ˜ =====

/**
 * Stage 1: Summarizer ì—ì´ì „íŠ¸ ì‹¤í–‰
 */
async function runSummarizer(text: string): Promise<SummaryResult> {
  console.log("ğŸ“ Stage 1: Summarizer ì‹¤í–‰ ì¤‘...");

  // ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” Claude API í˜¸ì¶œ
  // ì—¬ê¸°ì„œëŠ” êµ¬ì¡°ë§Œ ì •ì˜
  const prompt = `
ë‹¤ìŒ ëŒ€í™”ë¥¼ ì£¼ê°„ ìš”ì•½ í˜•ì‹ìœ¼ë¡œ ì •ë¦¬í•´ì£¼ì„¸ìš”.

ì›ë¬¸:
${text}
  `;

  // TODO: Claude API í˜¸ì¶œ
  // const response = await callClaude(prompt);

  // ì„ì‹œ ë°˜í™˜ (ì‹¤ì œ êµ¬í˜„ ì‹œ API ì‘ë‹µ íŒŒì‹±)
  return {
    highlights: [],
    projectStatus: [],
    nextWeek: [],
  };
}

/**
 * Stage 2: Decision Extractor ì—ì´ì „íŠ¸ ì‹¤í–‰
 */
async function runDecisionExtractor(text: string): Promise<Decision[]> {
  console.log("âœ… Stage 2: Decision Extractor ì‹¤í–‰ ì¤‘...");

  const prompt = `
ë‹¤ìŒ ëŒ€í™”ì—ì„œ ê²°ì • ì‚¬í•­ì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

ì›ë¬¸:
${text}
  `;

  // TODO: Claude API í˜¸ì¶œ
  return [];
}

/**
 * Stage 3: Action Extractor ì—ì´ì „íŠ¸ ì‹¤í–‰
 */
async function runActionExtractor(text: string): Promise<ActionItem[]> {
  console.log("ğŸ“‹ Stage 3: Action Extractor ì‹¤í–‰ ì¤‘...");

  const prompt = `
ë‹¤ìŒ ëŒ€í™”ì—ì„œ Action Itemì„ ì¶”ì¶œí•´ì£¼ì„¸ìš”.

ì›ë¬¸:
${text}
  `;

  // TODO: Claude API í˜¸ì¶œ
  return [];
}

// ===== ë¦¬í¬íŠ¸ ìƒì„± =====

/**
 * íŒŒì´í”„ë¼ì¸ ê²°ê³¼ë¥¼ ë§ˆí¬ë‹¤ìš´ ë¦¬í¬íŠ¸ë¡œ ë³€í™˜
 */
function generateReport(
  input: PipelineInput,
  output: PipelineOutput
): string {
  const { summary, decisions, actions, generatedAt } = output;

  const priorityEmoji = {
    high: "ğŸ”´",
    medium: "ğŸŸ¡",
    low: "ğŸŸ¢",
  };

  let report = `# ğŸ“Š ì£¼ê°„ ë¦¬í¬íŠ¸

> ê¸°ê°„: ${input.dateRange.start} ~ ${input.dateRange.end}
> íŒ€: ${input.team || "ì „ì²´"}
> ìƒì„±ì¼: ${generatedAt}

---

## ğŸ“‹ ì´ë²ˆ ì£¼ í•˜ì´ë¼ì´íŠ¸

${summary.highlights.map((h) => `- ${h}`).join("\n") || "- (ë‚´ìš© ì—†ìŒ)"}

---

## ğŸ“ í”„ë¡œì íŠ¸ë³„ ì§„í–‰ ìƒí™©

| í”„ë¡œì íŠ¸ | ìƒíƒœ | ì§„í–‰ë¥  |
|---------|------|-------|
${
  summary.projectStatus
    .map((p) => `| ${p.project} | ${p.status} | ${p.progress}% |`)
    .join("\n") || "| - | - | - |"
}

---

## âœ… ê²°ì • ì‚¬í•­

| # | ê²°ì • ë‚´ìš© | ê´€ë ¨ì | ì˜í–¥ë„ |
|---|----------|-------|-------|
${
  decisions
    .map(
      (d) =>
        `| ${d.id} | ${d.content} | ${d.participants.join(", ")} | ${priorityEmoji[d.impact]} ${d.impact} |`
    )
    .join("\n") || "| - | - | - | - |"
}

---

## ğŸ“ Action Items

| # | ì—…ë¬´ | ë‹´ë‹¹ì | ê¸°í•œ | ìš°ì„ ìˆœìœ„ |
|---|------|-------|------|---------|
${
  actions
    .map(
      (a) =>
        `| ${a.id} | ${a.task} | ${a.assignee || "TBD"} | ${a.deadline || "-"} | ${priorityEmoji[a.priority]} ${a.priority} |`
    )
    .join("\n") || "| - | - | - | - | - |"
}

---

## ğŸ“… ë‹¤ìŒ ì£¼ ê³„íš

${summary.nextWeek.map((n) => `- ${n}`).join("\n") || "- (ë‚´ìš© ì—†ìŒ)"}

---

*ğŸ¤– Generated by Weekly Summary Pipeline*
*ğŸ“ íŒŒì¼: reports/weekly/weekly-${generatedAt}.md*
`;

  return report;
}

/**
 * ë¦¬í¬íŠ¸ íŒŒì¼ ì €ì¥
 */
function saveReport(content: string, date: string): string {
  const filename = `weekly-${date}.md`;
  const filepath = path.join(CONFIG.outputDir, filename);

  // ë””ë ‰í† ë¦¬ í™•ì¸
  if (!fs.existsSync(CONFIG.outputDir)) {
    fs.mkdirSync(CONFIG.outputDir, { recursive: true });
  }

  fs.writeFileSync(filepath, content, "utf-8");
  return filepath;
}

// ===== ë©”ì¸ íŒŒì´í”„ë¼ì¸ =====

/**
 * Weekly Summary íŒŒì´í”„ë¼ì¸ ì‹¤í–‰
 */
async function runWeeklySummaryPipeline(
  input: PipelineInput
): Promise<string> {
  console.log("ğŸš€ Weekly Summary íŒŒì´í”„ë¼ì¸ ì‹œì‘");
  console.log(`ğŸ“… ê¸°ê°„: ${input.dateRange.start} ~ ${input.dateRange.end}`);
  console.log("");

  try {
    // Stage 1: Summarizer
    const summary = await runSummarizer(input.conversations);

    // Stage 2: Decision Extractor
    const decisions = await runDecisionExtractor(input.conversations);

    // Stage 3: Action Extractor
    const actions = await runActionExtractor(input.conversations);

    // ê²°ê³¼ í†µí•©
    const output: PipelineOutput = {
      summary,
      decisions,
      actions,
      generatedAt: getDateString(),
    };

    // ë¦¬í¬íŠ¸ ìƒì„±
    console.log("\nğŸ“„ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘...");
    const report = generateReport(input, output);

    // íŒŒì¼ ì €ì¥
    const filepath = saveReport(report, output.generatedAt);
    console.log(`\nâœ… ë¦¬í¬íŠ¸ ì €ì¥ ì™„ë£Œ: ${filepath}`);

    return filepath;
  } catch (error) {
    console.error("âŒ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì‹¤íŒ¨:", error);
    throw error;
  }
}

// ===== CLI ì‹¤í–‰ =====

async function main() {
  // ì¸ì íŒŒì‹±
  const args = process.argv.slice(2);
  const inputFile = args.find((a) => a.startsWith("--input="))?.split("=")[1];
  const team = args.find((a) => a.startsWith("--team="))?.split("=")[1];

  // ì…ë ¥ ë°ì´í„° ì¤€ë¹„
  let conversations = "";

  if (inputFile && fs.existsSync(inputFile)) {
    conversations = fs.readFileSync(inputFile, "utf-8");
  } else {
    // í…ŒìŠ¤íŠ¸ìš© ìƒ˜í”Œ ë°ì´í„°
    conversations = `
[2024-12-23 ì›”ìš”ì¼]
- API ì„¤ê³„ ë…¼ì˜: REST vs GraphQL â†’ RESTë¡œ ê²°ì •
- ê¹€ê°œë°œ: API ë¬¸ì„œ ì‘ì„± ì‹œì‘í•˜ê² ìŠµë‹ˆë‹¤

[2024-12-24 í™”ìš”ì¼]
- ë””ìì¸ ë¦¬ë·° ì™„ë£Œ
- ë°•ë””ìì¸: ì»´í¬ë„ŒíŠ¸ ìˆ˜ì • í•„ìš” (12/26ê¹Œì§€)

[2024-12-25 ìˆ˜ìš”ì¼]
- íœ´ì¼

[2024-12-26 ëª©ìš”ì¼]
- QA í…ŒìŠ¤íŠ¸ ì‹œì‘
- ë²„ê·¸ 3ê±´ ë°œê²¬ â†’ ì´í…ŒìŠ¤íŠ¸ê°€ 12/27ê¹Œì§€ ìˆ˜ì • ì˜ˆì •

[2024-12-27 ê¸ˆìš”ì¼]
- MVP ë°°í¬ ì™„ë£Œ
- ë‹¤ìŒ ì£¼ ì‚¬ìš©ì í”¼ë“œë°± ìˆ˜ì§‘ ì˜ˆì •
    `;
    console.log("âš ï¸ ì…ë ¥ íŒŒì¼ì´ ì—†ì–´ ìƒ˜í”Œ ë°ì´í„° ì‚¬ìš©\n");
  }

  const input: PipelineInput = {
    conversations,
    dateRange: getWeekRange(),
    team: team || "ê°œë°œíŒ€",
  };

  await runWeeklySummaryPipeline(input);
}

// ì‹¤í–‰
main().catch(console.error);
