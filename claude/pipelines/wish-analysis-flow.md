---
name: 소원 분석 파이프라인
description: 소원 입력 → 분석 → 기적지수 → 결과 전달 전체 흐름
version: 1.0.0
trigger: user_inquiry
---

# 소원 분석 파이프라인

소원이가 12문항에 응답하면 자동으로 기적지수를 분석하고 결과를 전달하는 전체 흐름입니다.

## 파이프라인 개요

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   1. 입력   │ →  │   2. 분석   │ →  │   3. 생성   │ →  │   4. 전달   │
│  12문항 수집 │    │  기적지수   │    │ 로드맵/메시지│    │  결과 발송  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

## 단계별 상세

### 1단계: 소원 입력 수집

**트리거**: 소원이가 카카오채널/웹에서 분석 시작

| 항목 | 설명 |
|------|------|
| 채널 | kakao, web, email |
| 수집 데이터 | 이름, 연락처, 12문항 응답 |
| 저장 위치 | PostgreSQL `wish_entries` 테이블 |
| 소요 시간 | 약 5-10분 |

**데이터 스키마**:
```json
{
  "entry_id": "ENT-20251228-001",
  "name": "달빛고래",
  "phone": "010-1234-5678",
  "channel": "kakao",
  "responses": {
    "q1": "아이의 건강한 성장",
    "q2": 8,
    "q3": "...",
    ...
  },
  "created_at": "2025-12-28T10:00:00Z"
}
```

### 2단계: 기적지수 분석

**실행 주체**: `@miracle-analyzer` 에이전트

| 항목 | 설명 |
|------|------|
| 분석 모델 | Claude Sonnet |
| 입력 | 12문항 응답 |
| 출력 | 기적지수(50-100), 5대 지표 점수 |
| 소요 시간 | 약 10-30초 |

**분석 프롬프트**: `prompts/analysis/miracle-index.md`

**출력 스키마**:
```json
{
  "miracle_index": 72,
  "indicators": {
    "belief": 75,
    "persistence": 68,
    "practicality": 70,
    "adaptability": 78,
    "gratitude": 69
  },
  "analysis": {
    "strengths": ["긍정적 마음가짐", "목표 명확성"],
    "improvements": ["일관성 유지", "구체적 계획 수립"]
  }
}
```

### 3단계: 콘텐츠 생성

**병렬 실행**: 로드맵 + 응원 메시지 동시 생성

#### 3-1. 30일 로드맵 생성

| 항목 | 설명 |
|------|------|
| 실행 주체 | `@roadmap-generator` 스킬 |
| 입력 | 기적지수, 소원 내용 |
| 출력 | PDF 로드맵 |
| 도구 | `create_roadmap`, `export_pdf` |

#### 3-2. 7일 응원 메시지 생성

| 항목 | 설명 |
|------|------|
| 실행 주체 | `@wish-writer` 스킬 |
| 입력 | 이름, 소원 |
| 출력 | 14개 메시지 (아침 7 + 저녁 7) |
| 도구 | `generate_messages` |

### 4단계: 결과 전달

**실행 주체**: `@message-dispatcher` 스킬

| 전달 채널 | 내용 | 타이밍 |
|-----------|------|--------|
| 카카오톡 | 분석 완료 알림 | 즉시 |
| 이메일 | PDF 로드맵 첨부 | 즉시 |
| 카카오톡 | 아침 응원 메시지 | 매일 08:00 |
| 카카오톡 | 저녁 응원 메시지 | 매일 20:00 |

## 에러 핸들링

| 단계 | 에러 유형 | 대응 |
|------|----------|------|
| 1 | 입력 미완료 | 24시간 후 리마인드 발송 |
| 2 | AI 분석 실패 | 재시도 3회, 실패 시 수동 처리 |
| 3 | PDF 생성 실패 | 텍스트 버전 먼저 발송 |
| 4 | 발송 실패 | 대체 채널로 전환 |

## 모니터링

| 지표 | 정상 범위 | 알림 조건 |
|------|----------|----------|
| 분석 완료율 | > 95% | < 90% |
| 평균 소요 시간 | < 1분 | > 3분 |
| 발송 성공률 | > 98% | < 95% |

## 관련 파일

| 유형 | 파일 |
|------|------|
| 에이전트 | `claude/agents/miracle-analyzer.md` |
| 스킬 | `claude/skills/roadmap-generator.md`, `claude/skills/wish-writer.md` |
| 프롬프트 | `prompts/analysis/miracle-index.md` |
| MCP | `miracle-mcp` (analyze_miracle_score) |

## 사용 예시

```bash
# 전체 파이프라인 수동 실행
node scripts/run-pipeline.js --pipeline=wish-analysis --entry-id=ENT-20251228-001

# 특정 단계만 재실행
node scripts/run-pipeline.js --pipeline=wish-analysis --step=3 --entry-id=ENT-20251228-001
```
