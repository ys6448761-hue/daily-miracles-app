<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²°ì œ ì™„ë£Œ | í•˜ë£¨í•˜ë£¨ì˜ ê¸°ì </title>
  <style>
    body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background: #fff; color: #111; }
    .wrap { max-width: 720px; margin: 0 auto; padding: 48px 20px; }
    h1 { font-size: 28px; margin: 0 0 20px; }
    .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,.04); }
    .title { font-size: 20px; font-weight: 700; margin: 0; }
    .sub { margin: 8px 0 0; font-size: 14px; color: #4b5563; }
    .info { margin-top: 16px; background: #f9fafb; border-radius: 12px; padding: 14px; }
    .row { display: flex; justify-content: space-between; gap: 12px; padding: 8px 0; border-bottom: 1px solid #eef2f7; }
    .row:last-child { border-bottom: 0; }
    .label { color: #6b7280; font-size: 13px; }
    .value { font-size: 13px; text-align: right; word-break: break-all; }
    .badge-ok { font-weight: 700; color: #047857; }
    .badge-warn { font-weight: 700; color: #b45309; }
    .badge-err { font-weight: 700; color: #b91c1c; }
    .hint { margin-top: 12px; font-size: 12px; color: #6b7280; }
    .btns { margin-top: 18px; display: flex; flex-wrap: wrap; gap: 10px; }
    .btn { border-radius: 12px; padding: 12px 14px; font-size: 14px; font-weight: 700; cursor: pointer; border: 1px solid #d1d5db; background: #fff; }
    .btn.primary { background: #111; color: #fff; border-color: #111; }
    .muted { color: #6b7280; }
    .loader { display: inline-block; width: 10px; height: 10px; border: 2px solid #e5e7eb; border-top: 2px solid #111; border-radius: 999px; animation: spin 1s linear infinite; margin-right: 6px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    code { background: #f3f4f6; padding: 2px 6px; border-radius: 8px; }
  </style>
</head>
<body>
  <main class="wrap">
    <h1>ê²°ì œì •ë³´</h1>

    <section class="card" id="card">
      <p class="title" id="headline"><span class="loader"></span>ê²°ì œ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤â€¦</p>
      <p class="sub" id="subtitle">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</p>

      <div class="info" id="info" style="display:none;">
        <div class="row"><div class="label">ì£¼ë¬¸ë²ˆí˜¸</div><div class="value" id="v_orderId">-</div></div>
        <div class="row"><div class="label">ê²°ì œ ê¸ˆì•¡</div><div class="value" id="v_amount">-</div></div>
        <div class="row"><div class="label">ê²°ì œ ìˆ˜ë‹¨</div><div class="value" id="v_method">-</div></div>
        <div class="row"><div class="label">ê²°ì œ ì¼ì‹œ</div><div class="value" id="v_paidAt">-</div></div>
        <div class="row"><div class="label">ìƒíƒœ</div><div class="value" id="v_status">-</div></div>
      </div>

      <p class="hint" id="hint" style="display:none;">
        â€» ë³¸ ê²°ì œëŠ” ì •ìƒ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì œê°€ ìˆì„ ê²½ìš° ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.
      </p>

      <div class="btns" id="btns" style="display:none;">
        <button class="btn primary" id="btnStart">í”„ë¡œê·¸ë¨ ë°”ë¡œ ì‹œì‘í•˜ê¸°</button>
        <button class="btn" id="btnMy">ë‚˜ì˜ ê¸°ì  ì•„ì¹´ì´ë¸Œ</button>
        <button class="btn" id="btnHome">í™ˆìœ¼ë¡œ</button>
        <button class="btn" id="btnRetry" style="display:none;">ë‹¤ì‹œ í™•ì¸í•˜ê¸°</button>
      </div>

      <p class="hint muted" id="debug" style="display:none;"></p>
    </section>
  </main>

  <script>
    (function () {
      const qs = new URLSearchParams(location.search);
      const orderId = qs.get("orderId") || "";
      const vt = qs.get("vt") || "";

      const headline = document.getElementById("headline");
      const subtitle = document.getElementById("subtitle");
      const info = document.getElementById("info");
      const hint = document.getElementById("hint");
      const btns = document.getElementById("btns");
      const debug = document.getElementById("debug");

      const v_orderId = document.getElementById("v_orderId");
      const v_amount = document.getElementById("v_amount");
      const v_method = document.getElementById("v_method");
      const v_paidAt = document.getElementById("v_paidAt");
      const v_status = document.getElementById("v_status");

      const btnStart = document.getElementById("btnStart");
      const btnMy = document.getElementById("btnMy");
      const btnHome = document.getElementById("btnHome");
      const btnRetry = document.getElementById("btnRetry");

      function formatKRW(n) {
        if (typeof n !== "number") return "-";
        return new Intl.NumberFormat("ko-KR").format(n) + "ì›";
      }

      function formatDate(dateStr) {
        if (!dateStr) return "-";
        try {
          const d = new Date(dateStr);
          return d.toLocaleString("ko-KR", { year: "numeric", month: "2-digit", day: "2-digit", hour: "2-digit", minute: "2-digit" });
        } catch {
          return dateStr;
        }
      }

      function setRows(payment) {
        v_orderId.textContent = payment.orderId || orderId || "-";
        v_amount.textContent = formatKRW(payment.amount);
        v_method.textContent = payment.cardName ? payment.cardName + " " + (payment.cardNo || "") : "ì¹´ë“œ";
        v_paidAt.textContent = formatDate(payment.paidAt);
      }

      function showBaseUI() {
        info.style.display = "block";
        btns.style.display = "flex";
      }

      function showPaid(payment) {
        headline.textContent = "ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰";
        subtitle.textContent = "í•˜ë£¨í•˜ë£¨ì˜ ê¸°ì ì— ì°¸ì—¬í•´ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.";
        showBaseUI();
        setRows(payment);
        v_status.innerHTML = '<span class="badge-ok">ê²°ì œ ì™„ë£Œ</span>';
        hint.style.display = "block";
        btnRetry.style.display = "none";
      }

      function showNotPaid(payment, message) {
        headline.textContent = "ê²°ì œ ìƒíƒœ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤";
        subtitle.textContent = message || "ê²°ì œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.";
        showBaseUI();
        setRows(payment || {});
        const st = (payment && payment.status) ? payment.status : "UNKNOWN";
        v_status.innerHTML = '<span class="badge-warn">' + st + '</span>';
        hint.style.display = "none";
        btnRetry.style.display = "inline-block";
      }

      function showError(msg) {
        headline.textContent = "ê²°ì œ í™•ì¸ ë¶ˆê°€";
        subtitle.textContent = msg || "ê²°ì œ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ ì£¼ì„¸ìš”.";
        showBaseUI();
        v_orderId.textContent = orderId || "-";
        v_amount.textContent = "-";
        v_method.textContent = "-";
        v_paidAt.textContent = "-";
        v_status.innerHTML = '<span class="badge-err">UNKNOWN</span>';
        hint.style.display = "none";
        btnRetry.style.display = "inline-block";
      }

      // ë²„íŠ¼ ì´ë™ (ì›í•˜ëŠ” ê²½ë¡œë¡œ ìˆ˜ì • ê°€ëŠ¥)
      btnStart.addEventListener("click", function() { location.href = "/program-success.html"; });
      btnMy.addEventListener("click", function() { location.href = "https://dailymiracles.kr"; });
      btnHome.addEventListener("click", function() { location.href = "https://dailymiracles.kr"; });
      btnRetry.addEventListener("click", function() { location.reload(); });

      // 1) íŒŒë¼ë¯¸í„° ì²´í¬
      if (!orderId || !vt) {
        showError("ê²°ì œ í™•ì¸ ì •ë³´(orderId/vt)ê°€ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      // 2) verify API í˜¸ì¶œ
      // API ì‘ë‹µ í˜•ì‹: { success: true, payment: { orderId, amount, status, paidAt, cardName, cardNo, goodsName } }
      var url = "/api/payments/verify?orderId=" + encodeURIComponent(orderId) + "&vt=" + encodeURIComponent(vt);

      fetch(url, { method: "GET", headers: { "Accept": "application/json" } })
        .then(function(res) {
          return res.json();
        })
        .then(function(json) {
          console.log("[verify] response:", json);

          if (!json) {
            throw new Error("verify ì‘ë‹µ íŒŒì‹± ì‹¤íŒ¨");
          }

          // API ì‘ë‹µ: { success: true/false, payment: {...} } ë˜ëŠ” { success: false, error, message }
          if (json.success === true && json.payment) {
            var payment = json.payment;
            if (payment.status === "PAID") {
              showPaid(payment);
            } else {
              showNotPaid(payment, "ê²°ì œ ìƒíƒœ: " + payment.status);
            }
          } else {
            showError(json.message || "ê²°ì œ í™•ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
          }
        })
        .catch(function(err) {
          console.error("[verify] error:", err);
          showError("ê²°ì œ í™•ì¸ ì¤‘ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
        });
    })();
  </script>
</body>
</html>
