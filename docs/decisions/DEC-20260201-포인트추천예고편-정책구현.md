# DEC-20260201 — 포인트/추천/예고편(Preview) 정책·구현 결정로그 v1

- 일자: 2026-02-01 (KST)
- 작성: 루미(분석)
- 목적: 오늘 확정된 "정책(SSOT) + 구현 하드가드 + 운영 절차"를 한 문서에 고정하여, **코드/운영/CS가 같은 기준**을 보도록 한다.

---

## 1) 오늘의 최종 확정(SSOT)

### 1-1. 무료 정책
- 무료는 **Always-On**(7일 후 강제 종료/추방 없음)
- 비용 통제 가드레일: 동시 활성 소원 1개 / 일일 제출 2회(추후 조건부 확대)

### 1-2. 포인트 기본값
- 일 최대 100P
  - 출석 50P + 실행체크(24h 행동) 30P + 기록(로그) 20P
- 포인트 만료: 90일
- 원칙: 잔액은 **원장(ledger) 합산**이 SSOT (캐시는 선택)

### 1-3. 예고편(Preview) 교환
- 가격: 900P
- 제공물: Preview 전용 1페이지 PDF(핵심요약 + 인사이트 2 + 24h 행동 1)
- 하드가드(필수):
  - 워터마크 있음 / 저해상도 / 1페이지
  - 링크 24h 만료 + 1회 다운로드
  - 재다운로드 불가 / 보관함 저장 없음 / 수정·리셋·진행률 연동 없음
- 자격조건: 최근 7일 출석 ≥3 + 실행체크 ≥1
- 상한: 유저 주 1회 + 전체 주 100건
- 실패 시: PDF 생성 실패 → 900P 환불(또는 플래그 OFF 운영)

### 1-4. 친구추천(Referral)
- 신규(B): 코드 적용 시 300P 즉시 지급(1회)
- 추천자(A): B가 QUALIFIED 달성 시 300P 지급(베스팅)
- QUALIFIED: 7일 내 출석 ≥2 + 실행체크 ≥1
- 상한: A 월 5명까지 보상 인정
- 어뷰징: 반복/다계정 의심 → HOLD 큐(운영자 검토) + 필요 시 REVOKE

---

## 2) 운영 원칙(Feature Flag / 배치)

### 2-1. Feature Flag 3종
- points_enabled
- referral_enabled
- preview_redemption_enabled

권장 순차 ON: points → referral → preview

### 2-2. 배치 스케줄(예시: GitHub Actions, UTC 환산)
- 포인트 만료: 매일 00:00 KST (= 15:00 UTC)
- 추천 자격 확인: 매일 10:00 KST (= 01:00 UTC)
- 중복 실행 방지: Advisory Lock 적용(필수)

---

## 3) 구현 산출물(핵심 파일 요약)

### 3-1. 포인트/추천/예고편 시스템(1차)
- migrations/005_points_referral_schema.sql (+ migrate-005 runner)
- services: pointService / previewService / referralService
- routes: /api/points, /api/rewards, /api/referral, /api/admin (feature flags 포함)
- jobs: pointExpirationJob, referralQualificationJob (Advisory Lock 포함)
- server.js: 라우트 통합

### 3-2. Gap 해소(2차)
- routes/dailyCheckRoutes.js: 일일 체크 API(출석/실행/기록) → pointService 연동
- migrations/006_daily_checks_table.sql (+ migrate-006 runner 필요 시)
- previewService: pdfkit 기반 Preview PDF 생성(generatePreviewPDF) + 실패 환불(refundOnFailure)
- routes/rewardRoutes.js: 실제 PDF 다운로드 처리
- public/points.html: 포인트 대시보드(최소 UI)

---

## 4) 미해결/주의(최종 마감 전 필수 확인)

### P0 필수
1) DB 마이그레이션 006 적용( daily_checks 테이블 ) ✅ 완료
2) /points?subject_id=... 접근 제어 점검 ✅ 완료 (token 기반으로 변경)
   - subject_id를 신뢰하지 말고 서버에서 user_id로 매핑(또는 관리자 권한만 허용)

### P1 권장
3) Preview PDF 정리 배치(24h 지난 파일 자동 삭제) 또는 저장소 수명주기 정책
4) pdfkit 한글 폰트(나눔고딕 등) 추가로 렌더링 품질 개선

---

## 5) 수용 기준(운영 오픈 전 스모크 테스트)

- 포인트: 하루 100P 상한 / 90일 만료 적용
- 추천: B 300P 1회 / A 베스팅(QUALIFIED 전 미지급) / 월 5명 상한 / HOLD 큐
- 예고편: 900P 차감 / PDF 생성 / 워터마크·1페이지 / 24h 만료·1회 다운로드 / 실패 환불
- UI: 잔액 표시 + 오늘 체크리스트 + 예고편 교환 버튼(사유 표시)

---

## 6) 저장/배포 규칙(권장)

- 이 DEC 문서는 repo의 /docs/decisions/ 아래에 저장
- 작업지시서는 /docs/runbooks/ 또는 /docs/implementation/에 저장
- PR 템플릿에 "SSOT 변경 여부 / 하드가드 체크 / 플래그 상태 / 마이그레이션" 체크박스 포함

---

*작성: 루미 | 승인: 푸르미르 CEO | 2026-02-01*
