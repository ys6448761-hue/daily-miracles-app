# 정산 테스트 케이스 (AIL-정산-v2-final)

## 실행 방법

```bash
node tests/settlement/settlement-v2-testcases.js
```

## Gate 조건

- [ ] 20개 테스트 전체 통과
- [ ] 모든 케이스에서 `원장 합계 = 배분 합계 = 지급 합계`
- [ ] Idempotency 보장

---

## 테스트 케이스 목록 (20개)

### 기본 결제 (5개)

| ID | 케이스 | Gross | Coupon | 검증 포인트 |
|----|--------|-------|--------|------------|
| TC-001 | 기본 결제 | ₩10,000 | 0 | 기본 배분 정확성 |
| TC-002 | 고가 상품 | ₩100,000 | 0 | 대금액 정확성 |
| TC-003 | 최소 금액 | ₩1,000 | 0 | 최소 금액 처리 |
| TC-004 | 중간 금액 | ₩29,900 | 0 | 일반 금액 |
| TC-005 | 소수점 발생 | ₩33,333 | 0 | 반올림 오차 검증 |

### 쿠폰 (3개)

| ID | 케이스 | Gross | Coupon | 검증 포인트 |
|----|--------|-------|--------|------------|
| TC-006 | 10% 할인 | ₩10,000 | ₩1,000 | 쿠폰=플랫폼 부담 |
| TC-007 | 50% 대폭 할인 | ₩20,000 | ₩10,000 | 크리에이터 영향 없음 |
| TC-008 | 정액 할인 | ₩15,000 | ₩3,000 | Anchor 계산 정확성 |

### 추천 (3개)

| ID | 케이스 | Referrer | 검증 포인트 |
|----|--------|----------|------------|
| TC-009 | 추천자 있음 | ✓ | 성장풀 7% 지급 |
| TC-010 | 추천+쿠폰 복합 | ✓ | 쿠폰과 추천 독립 |
| TC-011 | 추천 없음 | ✗ | 성장풀 적립 |

### 리믹스 체인 (4개)

| ID | 케이스 | 체인 깊이 | 검증 포인트 |
|----|--------|----------|------------|
| TC-012 | 1단계 | 1 | 단일 부모 분배 |
| TC-013 | 2단계 | 2 | 균등 분배 |
| TC-014 | 3단계 (최대) | 3 | 3등분 분배 |
| TC-015 | 4단계 (초과) | 3 | 4번째 무시 확인 |

### 복합 케이스 (2개)

| ID | 케이스 | 구성 | 검증 포인트 |
|----|--------|------|------------|
| TC-016 | 쿠폰+추천+리믹스 | ₩50K, 10%할인, 2단계, 추천 | 전체 흐름 |
| TC-017 | 고가 복합 | ₩100K, 10%할인, 3단계, 추천 | 고가 복합 |

### 환불/차지백 (3개)

| ID | 케이스 | 유형 | 검증 포인트 |
|----|--------|------|------------|
| TC-018 | 전액 환불 | REFUND | 역분개 정확성 |
| TC-019 | 부분 환불 | REFUND | 부분 역분개 |
| TC-020 | 차지백 | CHARGEBACK | 리믹스+추천 역분개 |

---

## 상세 케이스 출력

특정 케이스의 상세 계산 결과 확인:

```javascript
const { printDetailedCase } = require('./settlement-v2-testcases');
printDetailedCase('TC-016');
```

출력 예시:
```
═══════════════════════════════════════════════════════════════
TC-016: 복합 - 쿠폰 + 추천 + 리믹스 2단계
═══════════════════════════════════════════════════════════════

【입력】
  Gross: ₩50,000
  Coupon: ₩5,000
  Remix Chain: creator_p1 → creator_p2
  Referrer: user_ref_complex

【계산 결과】
  Paid: ₩45,000
  PG Fee: ₩1,485 (3.3%)
  Net Cash: ₩43,515
  Anchor: ₩48,350

【풀별 배분】
  Platform (55%): ₩26,593
  Creator (30%): ₩14,505
  Growth (10%): ₩4,835
  Risk (5%): ₩2,418

【크리에이터 상세】
  Original (70%): ₩10,154
  Remix (20%): ₩2,901
    └ creator_p1 (Depth 1): ₩1,451
    └ creator_p2 (Depth 2): ₩1,451
  Curation (10%): ₩1,451

【성장 상세】
  Referrer (7%): ₩3,385
  Campaign (3%): ₩1,451
  Reserve: ₩0

【검증】
  Total Distributed: ₩43,515
  Net Cash: ₩43,515
  Balance Check: ✅ PASS
```

---

## 상수 참조

```javascript
const SETTLEMENT_CONSTANTS = {
  // 배분 비율
  PLATFORM_RATE: 0.55,
  CREATOR_POOL_RATE: 0.30,
  GROWTH_POOL_RATE: 0.10,
  RISK_POOL_RATE: 0.05,

  // 크리에이터 내부
  CREATOR_ORIGINAL_RATE: 0.70,
  CREATOR_REMIX_RATE: 0.20,
  CREATOR_CURATION_RATE: 0.10,
  REMIX_MAX_DEPTH: 3,

  // 성장 내부
  GROWTH_REFERRER_RATE: 0.07,
  GROWTH_CAMPAIGN_RATE: 0.03,

  // 정책
  HOLD_DAYS: 14,
  MIN_PAYOUT: 10000,
  PG_FEE_RATE: 0.033,
};
```
