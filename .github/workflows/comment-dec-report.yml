name: Comment DEC Report to PR (copy-friendly approve command)

on:
  workflow_call:
    inputs:
      report_glob:
        description: "ë¦¬í¬íŠ¸ íŒŒì¼ glob (ìµœì‹  íŒŒì¼ 1ê°œë¥¼ ì„ íƒ)"
        required: false
        type: string
        default: "artifacts/reports/*.md"
      title:
        description: "ì½”ë©˜íŠ¸ ì œëª©"
        required: false
        type: string
        default: "ğŸ“Š DEC ìë™ ë¦¬í¬íŠ¸"
      decider_default:
        description: "ìŠ¹ì¸ ì»¤ë§¨ë“œ ê¸°ë³¸ decider"
        required: false
        type: string
        default: "í‘¸ë¥´ë¯¸ë¥´"
      query_hint:
        description: "ìŠ¹ì¸ ì»¤ë§¨ë“œì— ë„£ì„ ê¸°ë³¸ query íŒíŠ¸(ë¦¬í¬íŠ¸ì—ì„œ ëª» ë½‘ìœ¼ë©´ ì‚¬ìš©)"
        required: false
        type: string
        default: "ì¿¼ë¦¬_ì—¬ê¸°ì—_ì…ë ¥"

jobs:
  comment:
    # PR ì»¨í…ìŠ¤íŠ¸ì—ì„œë§Œ ì½”ë©˜íŠ¸
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Find latest DEC report
        id: report
        shell: bash
        run: |
          set -e
          REPORT="$(ls -t ${{ inputs.report_glob }} 2>/dev/null | head -n 1 || true)"
          if [ -z "$REPORT" ]; then
            echo "No report found for glob: ${{ inputs.report_glob }}"
            exit 1
          fi
          echo "report=$REPORT" >> "$GITHUB_OUTPUT"
          echo "Found report: $REPORT"

      - name: Extract query from report (best-effort)
        id: q
        shell: bash
        run: |
          set -e
          REPORT="${{ steps.report.outputs.report }}"

          # ë¦¬í¬íŠ¸ ë‚´ì— Query: "..." ë˜ëŠ” Query: ... ê°™ì€ ë¼ì¸ì´ ìˆìœ¼ë©´ ì¶”ì¶œ
          # (ì—†ìœ¼ë©´ query_hint ì‚¬ìš©)
          QUERY_LINE="$(grep -E '^\s*(Query|ì¿¼ë¦¬)\s*:\s*' "$REPORT" | head -n 1 || true)"
          if [ -n "$QUERY_LINE" ]; then
            # Query: "ì‹ í˜¸ë“± ì‹œìŠ¤í…œ" í˜•íƒœ ê°€ì •
            QUERY="$(echo "$QUERY_LINE" | sed -E 's/^\s*(Query|ì¿¼ë¦¬)\s*:\s*//; s/^"//; s/"$//')"
          else
            QUERY="${{ inputs.query_hint }}"
          fi

          # í•œ ì¤„ ì•ˆì „ ì²˜ë¦¬
          QUERY="$(echo "$QUERY" | tr '\n' ' ' | sed -E 's/\s+/ /g' | sed -E 's/^\s+|\s+$//g')"
          echo "query=$QUERY" >> "$GITHUB_OUTPUT"
          echo "Using query: $QUERY"

      - name: Read report content (top 120 lines)
        id: content
        shell: bash
        run: |
          set -e
          REPORT="${{ steps.report.outputs.report }}"

          echo "content<<EOF" >> "$GITHUB_OUTPUT"
          sed -n '1,120p' "$REPORT" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Comment on PR (with copy-friendly approve command)
        uses: actions/github-script@v7
        with:
          script: |
            const title = `${{ toJson(inputs.title) }}`;
            const reportPath = `${{ toJson(steps.report.outputs.report) }}`;
            const reportTop = `${{ toJson(steps.content.outputs.content) }}`;
            const query = `${{ toJson(steps.q.outputs.query) }}`;
            const decider = `${{ toJson(inputs.decider_default) }}`;

            // "ë³µë¶™ ë²„íŠ¼ ëŠë‚Œ" = GitHub ì½”ë“œë¸”ë¡ì˜ Copy UI í™œìš©
            const approveCmd = [
              'DEC_PROMOTE_TOKEN=YOUR_TOKEN node scripts/debate-trigger.js \\',
              `  --query "${query}" \\`,
              '  --generate-dec-draft \\',
              '  --promote \\',
              `  --decider "${decider}" \\`,
              '  --delete-draft \\',
              '  --log'
            ].join('\n');

            const body = [
              `## ${title}`,
              ``,
              `### âœ… ìŠ¹ì¸(ì •ì‹ DEC ë°œí–‰) â€” ë³µë¶™ìš© ì»¤ë§¨ë“œ`,
              `ğŸ‘‰ ì•„ë˜ ë°•ìŠ¤ ìš°ì¸¡ ìƒë‹¨ **Copy** ë²„íŠ¼ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë³µì‚¬í•´ ë¡œì»¬ í„°ë¯¸ë„ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.`,
              ``,
              '```bash',
              approveCmd,
              '```',
              ``,
              `<details>`,
              `<summary><b>ğŸ“Œ í† í°/í™˜ê²½ë³€ìˆ˜ ì•ˆë‚´ (í´ë¦­)</b></summary>`,
              ``,
              `- \`DEC_PROMOTE_TOKEN\`ì€ **ë¡œì»¬ì—ì„œë§Œ** ì‚¬ìš©í•©ë‹ˆë‹¤. (GitHub Actionsì—ëŠ” ë„£ì§€ ì•ŠìŒ)`,
              `- ì˜ˆì‹œ:`,
              `  - macOS/Linux:`,
              `    \`\`\`bash`,
              `    export DEC_PROMOTE_TOKEN="secret"`,
              `    \`\`\``,
              `  - Windows PowerShell:`,
              `    \`\`\`powershell`,
              `    $env:DEC_PROMOTE_TOKEN="secret"`,
              `    \`\`\``,
              ``,
              `</details>`,
              ``,
              `---`,
              ``,
              `<details>`,
              `<summary><b>ğŸ“„ ë¦¬í¬íŠ¸ ìš”ì•½ (ìƒë‹¨ 120ì¤„)</b></summary>`,
              ``,
              '```md',
              reportTop,
              '```',
              ``,
              `ğŸ“ ì „ì²´ ë¦¬í¬íŠ¸ ê²½ë¡œ: \`${reportPath}\``,
              `</details>`
            ].join('\n');

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body
            });
