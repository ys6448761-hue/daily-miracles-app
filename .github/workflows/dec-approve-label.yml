name: DEC Approve Label (comment trigger)

on:
  issue_comment:
    types: [created]

jobs:
  check-approve-command:
    # PR ì½”ë©˜íŠ¸ë§Œ ì²˜ë¦¬ (issue ì½”ë©˜íŠ¸ ì œì™¸)
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/dec approved')
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write

    steps:
      - name: Ensure labels exist
        uses: actions/github-script@v7
        with:
          script: |
            const labels = [
              { name: 'DEC-PENDING', color: 'FBCA04', description: 'DEC ìŠ¹ì¸ ëŒ€ê¸° ì¤‘' },
              { name: 'DEC-APPROVED', color: '0E8A16', description: 'DEC ìŠ¹ì¸ ì™„ë£Œ' }
            ];

            for (const label of labels) {
              try {
                await github.rest.issues.getLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: label.name
                });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                  console.log(`Created label "${label.name}"`);
                }
              }
            }

      - name: Add DEC-APPROVED label
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.issue.number;
            const commenter = context.payload.comment.user.login;

            console.log(`Processing /dec approved command from @${commenter} on PR #${prNumber}`);

            // DEC-APPROVED ë¼ë²¨ ì¶”ê°€
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['DEC-APPROVED']
            });

            // DEC-PENDING ë¼ë²¨ ì œê±°
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                name: 'DEC-PENDING'
              });
              console.log('Removed DEC-PENDING label');
            } catch (e) {
              if (e.status !== 404) {
                throw e;
              }
            }

            // í™•ì¸ ë¦¬ì•¡ì…˜ ì¶”ê°€
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: context.payload.comment.id,
              content: 'rocket'
            });

            // í™•ì¸ ì½”ë©˜íŠ¸ (ìƒì„¸)
            const today = new Date();
            const kst = new Date(today.getTime() + 9 * 60 * 60 * 1000);
            const dateStr = kst.toISOString().slice(0, 10).replace(/-/g, '-');
            const decPath = `docs/decisions/`;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                `## âœ… ì •ì‹ DEC ë°œí–‰ ì™„ë£Œ`,
                ``,
                `**ìŠ¹ì¸ì**: @${commenter}`,
                `**ìŠ¹ì¸ì¼**: ${dateStr}`,
                ``,
                `### ğŸ“„ DEC ë¬¸ì„œ ìœ„ì¹˜`,
                `\`${decPath}DEC-${dateStr.replace(/-/g, '-')}-###.md\``,
                ``,
                `ğŸ”— [DEC ë¬¸ì„œ í´ë” ë³´ê¸°](${repoUrl}/tree/main/${decPath})`,
                ``,
                `---`,
                `ğŸ·ï¸ ë¼ë²¨: \`DEC-PENDING\` â†’ \`DEC-APPROVED\``
              ].join('\n')
            });
