name: team-memory Weekly Digest

on:
  schedule:
    # Every Monday at 00:00 UTC (09:00 KST)
    - cron: '0 0 * * 1'
  workflow_dispatch:
    inputs:
      days:
        description: 'Number of days to include'
        required: false
        default: '7'

jobs:
  digest:
    runs-on: ubuntu-latest
    name: Generate and send digest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git log

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Generate digest
        id: digest
        run: |
          DAYS=${{ github.event.inputs.days || '7' }}
          echo "Generating digest for last ${DAYS} days..."
          python tools/generate_team_memory_digest.py --days=${DAYS} --output=slack --save

      - name: Send to Slack
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          python tools/generate_team_memory_digest.py --days=${{ github.event.inputs.days || '7' }} --output=slack

      - name: Commit digest log
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain .claude/team-memory/digests/)" ]; then
            git add .claude/team-memory/digests/
            git commit -m "docs: weekly digest $(date +%Y-W%V)

            Auto-generated by team-memory-digest workflow

            Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>"
            git push
            echo "✅ Digest saved and committed"
          else
            echo "ℹ️ No new digest to commit"
          fi

      - name: Summary
        run: |
          echo "## Weekly Digest Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Period: last ${{ github.event.inputs.days || '7' }} days" >> $GITHUB_STEP_SUMMARY
          echo "- Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "✅ Slack notification sent" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ SLACK_WEBHOOK_URL not configured" >> $GITHUB_STEP_SUMMARY
          fi
