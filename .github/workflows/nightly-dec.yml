name: Nightly DEC Candidates

on:
  schedule:
    # ë§¤ì¼ ìƒˆë²½ 2ì‹œ KST = 17:00 UTC (ì „ë‚ )
    - cron: '0 17 * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run mode (no actual execution)'
        required: false
        default: 'false'
        type: boolean
      priority:
        description: 'Priority filter (high|medium|low|all)'
        required: false
        default: 'high'
        type: choice
        options:
          - high
          - medium
          - low
          - all

jobs:
  nightly-dec:
    name: Generate DEC Candidates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Run nightly DEC candidates
        id: nightly
        env:
          PRIORITY: ${{ inputs.priority || 'high' }}
        run: |
          echo "ðŸŒ™ Starting nightly DEC candidate generation..."
          echo "   Priority: $PRIORITY"

          if [ "${{ inputs.dry_run }}" = "true" ]; then
            node scripts/ops/nightly-dec-candidates.js --priority "$PRIORITY" --dry-run --log
          else
            node scripts/ops/nightly-dec-candidates.js --priority "$PRIORITY" --log
          fi

          echo "âœ… Nightly candidates generation completed"

      - name: Generate daily report
        if: inputs.dry_run != 'true'
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "ðŸ“Š Generating daily report..."
          node scripts/ops/daily-dec-report.js --log --notify
          echo "âœ… Daily report generated"

      - name: Upload nightly run results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-run-results
          path: |
            artifacts/reports/nightly-run-*.json
            artifacts/reports/daily-dec-report-*.md
          if-no-files-found: ignore
          retention-days: 30

      - name: Upload generated drafts
        if: inputs.dry_run != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: dec-drafts
          path: docs/decisions/DEC-DRAFT-*.md
          if-no-files-found: ignore
          retention-days: 7

      - name: Summary
        if: always()
        env:
          PRIORITY: ${{ inputs.priority || 'high' }}
        run: |
          echo "## ðŸŒ™ Nightly DEC Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Priority Filter:** \`$PRIORITY\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Check for nightly run result
          TODAY=$(TZ=Asia/Seoul date +%Y%m%d)
          RESULT_FILE="artifacts/reports/nightly-run-${TODAY}.json"

          if [ -f "$RESULT_FILE" ]; then
            TOTAL=$(jq '.totalQueries' "$RESULT_FILE")
            SUCCESS=$(jq '.successCount' "$RESULT_FILE")
            FAILED=$(jq '.failureCount' "$RESULT_FILE")

            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| Total Queries | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "| Success | $SUCCESS |" >> $GITHUB_STEP_SUMMARY
            echo "| Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY

            if [ "$FAILED" != "0" ]; then
              echo "### âš ï¸ Failed Queries" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              jq -r '.items[] | select(.status=="failed") | "- \(.id): \(.query)"' "$RESULT_FILE" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "No results file found for today ($TODAY)" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“¦ Check artifacts for detailed reports." >> $GITHUB_STEP_SUMMARY

  upload-artifacts:
    needs: nightly-dec
    uses: ./.github/workflows/upload-dec-artifacts.yml
    with:
      artifact_name: nightly-dec-artifacts
      retention_days: 14
