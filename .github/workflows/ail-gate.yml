name: AIL Gate

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  push:
    branches: [ "main" ]

jobs:
  ail-gate:
    name: AIL Gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install deps
        run: npm ci

      - name: Run AIL gate
        run: node scripts/ops/skillsmp-gate.js

      - name: Check if docs-only PR
        id: docs-check
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              per_page: 100
            });

            // docs-safe ê²½ë¡œ íŒ¨í„´: docs/, .claude/, *.md (ë£¨íŠ¸ í¬í•¨)
            const docsSafePatterns = [
              /^docs\//,
              /^\.claude\//,
              /^[^/]+\.md$/,       // ë£¨íŠ¸ .md (README.md, CLAUDE.md ë“±)
              /\.md$/              // ëª¨ë“  .md íŒŒì¼
            ];

            const isDocsSafe = (f) => docsSafePatterns.some(p => p.test(f));
            const allDocsSafe = files.every(f => isDocsSafe(f.filename));

            console.log(`ë³€ê²½ íŒŒì¼ ${files.length}ê°œ:`);
            files.forEach(f => console.log(`  ${isDocsSafe(f.filename) ? 'ğŸ“„' : 'âš™ï¸'} ${f.filename}`));
            console.log(`\në¬¸ì„œ ì „ìš© PR: ${allDocsSafe ? 'âœ… YES' : 'âŒ NO'}`);

            core.setOutput('docs_only', allDocsSafe ? 'true' : 'false');

      - name: Check AIL Section in PR Body
        if: github.event_name == 'pull_request' && steps.docs-check.outputs.docs_only != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prBody = context.payload.pull_request.body || '';

            // AIL ì„¹ì…˜ ì¡´ì¬ ì—¬ë¶€ ì²´í¬
            const hasAilSection = prBody.includes('[AIL]') ||
                                  prBody.includes('AIL:') ||
                                  prBody.includes('```ail');

            // Source ID ì¡´ì¬ ì—¬ë¶€ ì²´í¬
            const hasSourceId = prBody.includes('Issue #') ||
                                prBody.includes('ì™¸ë¶€ í‹°ì¼“:') ||
                                /Source ID/i.test(prBody);

            console.log('='.repeat(50));
            console.log('AIL Gate ê²€ì‚¬ ê²°ê³¼');
            console.log('='.repeat(50));
            console.log(`AIL ì„¹ì…˜ ì¡´ì¬: ${hasAilSection ? 'âœ…' : 'âŒ'}`);
            console.log(`Source ID ì¡´ì¬: ${hasSourceId ? 'âœ…' : 'âŒ'}`);
            console.log('-'.repeat(50));

            if (!hasAilSection) {
              core.setFailed(`
            âŒ AIL Gate ì‹¤íŒ¨

            PR ë³¸ë¬¸ì— [AIL] ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.
            PR í…œí”Œë¦¿ì„ ì‚¬ìš©í•´ [AIL] ì„¹ì…˜ì„ ì‘ì„±í•´ì£¼ì„¸ìš”.

            í•„ìˆ˜ ì¡°ê±´:
            1. [AIL] ì„¹ì…˜ ë˜ëŠ” \`\`\`ail ì½”ë“œë¸”ë¡ í¬í•¨
            2. Source ID (Issue # ë˜ëŠ” ì™¸ë¶€ í‹°ì¼“) ëª…ì‹œ

            ì˜ˆì‹œ:
            ## [AIL] ì§€ì‹œì„œ
            \`\`\`ail
            [CONTEXT]
            - ë°°ê²½: ...
            [INSTRUCTION]
            1. ...
            \`\`\`
              `);
              return;
            }

            if (!hasSourceId) {
              core.warning('âš ï¸ Source IDê°€ ëª…ì‹œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¶Œì¥: Issue # ë˜ëŠ” ì™¸ë¶€ í‹°ì¼“ IDë¥¼ ëª…ì‹œí•´ì£¼ì„¸ìš”.');
            }

            console.log('âœ… AIL Gate í†µê³¼!');

      - name: Docs-only PR auto-pass
        if: github.event_name == 'pull_request' && steps.docs-check.outputs.docs_only == 'true'
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ“„ ë¬¸ì„œ ì „ìš© PR â€” AIL ì„¹ì…˜ ë©´ì œ"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ë³€ê²½ íŒŒì¼ì´ ëª¨ë‘ docs//.claude//.md ê²½ë¡œì…ë‹ˆë‹¤."
          echo "ì½”ë“œ ë³€ê²½ì´ ì—†ìœ¼ë¯€ë¡œ AIL ì§€ì‹œì„œ ì—†ì´ í†µê³¼í•©ë‹ˆë‹¤."
          echo "âœ… AIL Gate ìë™ í†µê³¼!"
