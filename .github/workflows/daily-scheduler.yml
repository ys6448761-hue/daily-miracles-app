# Aurora5 Daily Scheduler + ACT ê´€ì œíƒ‘
#
# ìŠ¤ì¼€ì¤„:
# - 00:10 KST: Daily Health Snapshot (Airtable ì €ì¥ + ì´ìƒ ê°ì§€)
# - 06:00 KST: Daily Funnel Report (ì „ì¼ í¼ë„ ë¶„ì„)
# - 09:00 KST: Daily Miracle Messages

name: Daily Scheduler

on:
  schedule:
    # UTC 15:10 = KST 00:10 (ìì • 10ë¶„ - Daily Snapshot)
    - cron: '10 15 * * *'
    # UTC 21:00 = KST 06:00 (ì˜¤ì „ 6ì‹œ - Funnel Report)
    - cron: '0 21 * * *'
    # UTC 00:00 = KST 09:00 (ì˜¤ì „ 9ì‹œ - Daily Messages)
    - cron: '0 0 * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      job_type:
        description: 'ì‹¤í–‰í•  ì‘ì—…'
        required: true
        default: 'snapshot'
        type: choice
        options:
          - snapshot
          - funnel-report
          - daily-messages
          - all

jobs:
  # ===== Daily Snapshot (00:10 KST) =====
  daily-snapshot:
    runs-on: ubuntu-latest
    if: github.event.schedule == '10 15 * * *' || github.event.inputs.job_type == 'snapshot' || github.event.inputs.job_type == 'all'

    steps:
      - name: Daily Health Snapshot
        run: |
          echo "ğŸ¥ Daily Health Snapshot ì‹¤í–‰..."
          response=$(curl -X POST "${{ secrets.API_BASE_URL }}/api/metrics/snapshot" \
            -H "Content-Type: application/json" \
            --silent \
            --show-error \
            --max-time 30)

          echo "Response: $response"

          # ì„±ê³µ ì—¬ë¶€ í™•ì¸
          success=$(echo $response | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "âŒ Snapshot ì €ì¥ ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… Snapshot ì €ì¥ ì™„ë£Œ"
          echo "Alerts: $(echo $response | jq -r '.alerts')"

      - name: Log Result
        if: always()
        run: |
          echo "Job: daily-snapshot"
          echo "Time: $(date)"
          echo "Status: ${{ job.status }}"

  # ===== Daily Funnel Report (06:00 KST) =====
  daily-funnel-report:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 21 * * *' || github.event.inputs.job_type == 'funnel-report' || github.event.inputs.job_type == 'all'

    steps:
      - name: Generate Daily Funnel Report
        run: |
          echo "ğŸ“Š Daily Funnel Report ìƒì„±..."
          response=$(curl -X POST "${{ secrets.API_BASE_URL }}/api/ops/funnel-report" \
            -H "Content-Type: application/json" \
            -d '{}' \
            --silent \
            --show-error \
            --max-time 60)

          echo "Response: $response"

          # ì„±ê³µ ì—¬ë¶€ í™•ì¸
          success=$(echo $response | jq -r '.success')
          if [ "$success" != "true" ]; then
            echo "âŒ í¼ë„ ë¦¬í¬íŠ¸ ìƒì„± ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… í¼ë„ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"
          echo "ğŸ“ˆ 1ì¤„ ìš”ì•½: $(echo $response | jq -r '.oneLine')"
          echo "ğŸš¨ ì•ŒëŒ ìˆ˜: $(echo $response | jq -r '.alerts')"

      - name: Log Result
        if: always()
        run: |
          echo "Job: daily-funnel-report"
          echo "Time: $(date)"
          echo "Status: ${{ job.status }}"

  # ===== Daily Messages (09:00 KST) =====
  send-daily-messages:
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 0 * * *' || github.event.inputs.job_type == 'daily-messages' || github.event.inputs.job_type == 'all'

    steps:
      - name: Trigger Daily Job
        run: |
          curl -X POST "${{ secrets.API_BASE_URL }}/jobs/daily-9am" \
            -H "Content-Type: application/json" \
            -H "x-scheduler-key: ${{ secrets.SCHEDULER_SECRET }}" \
            --fail \
            --silent \
            --show-error

      - name: Log Result
        if: always()
        run: |
          echo "Job: send-daily-messages"
          echo "Time: $(date)"
          echo "Status: ${{ job.status }}"

  # ===== Health Check (5ë¶„ë§ˆë‹¤ - ì¶”í›„ í™œì„±í™”) =====
  # health-check:
  #   runs-on: ubuntu-latest
  #   if: false  # ë¹„í™œì„±í™” ìƒíƒœ
  #   steps:
  #     - name: Check API Health
  #       run: |
  #         curl "${{ secrets.API_BASE_URL }}/api/health" --fail --silent
