$yml = @'
name: Approve DEC (safe mode: draft + copy command)

on:
  workflow_dispatch:
    inputs:
      query:
        description: "ê²€ìƒ‰/í† ë¡  ì¿¼ë¦¬ (í•„ìˆ˜)"
        required: true
        type: string
      decider:
        description: "ìŠ¹ì¸ìž ì´ë¦„ (ê¸°ë³¸: í‘¸ë¥´ë¯¸ë¥´)"
        required: false
        default: "í‘¸ë¥´ë¯¸ë¥´"
        type: string
      scopes:
        description: "ê²€ìƒ‰ ë²”ìœ„ (decisions,system,execution,team,all)"
        required: false
        default: "all"
        type: string
      mode:
        description: "ìš”ì•½ ëª¨ë“œ (general|decision|action)"
        required: false
        default: "decision"
        type: choice
        options:
          - general
          - decision
          - action
      k:
        description: "ìƒìœ„ ê²°ê³¼ ê°œìˆ˜"
        required: false
        default: "5"
        type: string
      delete_draft:
        description: "DRAFT ìƒì„± í›„ ì‚­ì œ(ê¸°ë³¸ false ê¶Œìž¥)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      pr_number:
        description: "PR ë²ˆí˜¸ (ë¼ë²¨ ë¶€ì°©ìš©, ë¹„ì›Œë‘ë©´ ë¼ë²¨ ìƒëžµ)"
        required: false
        default: ""
        type: string

jobs:
  approve-dec:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate DEC DRAFT (no promote)
        run: |
          echo "Query=${{ inputs.query }}"
          node scripts/debate-trigger.js \
            --query "${{ inputs.query }}" \
            --scopes "${{ inputs.scopes }}" \
            --mode "${{ inputs.mode }}" \
            --k "${{ inputs.k }}" \
            --generate-dec-draft \
            --decider "${{ inputs.decider }}" \
            --log

      - name: Optionally delete drafts (best-effort)
        if: ${{ inputs.delete_draft == 'true' }}
        run: |
          rm -f docs/decisions/DEC-DRAFT-*.md || true

      - name: Write copy-friendly approve command to workflow summary
        run: |
          {
            echo "## âœ… ìŠ¹ì¸(ì •ì‹ DEC ë°œí–‰) ë³µë¶™ìš© ì»¤ë§¨ë“œ"
            echo ""
            echo "> ì•„ëž˜ ë°•ìŠ¤ ìš°ì¸¡ ìƒë‹¨ **Copy** ë²„íŠ¼ìœ¼ë¡œ ë³µì‚¬í•´ ë¡œì»¬(í† í° ë³´ìœ  í™˜ê²½)ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”."
            echo ""
            echo '```bash'
            echo 'DEC_PROMOTE_TOKEN=YOUR_TOKEN node scripts/debate-trigger.js \'
            echo "  --query \"${{ inputs.query }}\" \\"
            echo '  --generate-dec-draft \'
            echo '  --promote \'
            echo "  --decider \"${{ inputs.decider }}\" \\"
            echo '  --delete-draft \'
            echo '  --log'
            echo '```'
            echo ""
            echo "### ìž…ë ¥ê°’"
            echo "- query: \`${{ inputs.query }}\`"
            echo "- scopes: \`${{ inputs.scopes }}\`"
            echo "- mode: \`${{ inputs.mode }}\`"
            echo "- k: \`${{ inputs.k }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Add DEC-PENDING label to PR
        if: ${{ inputs.pr_number != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}', 10);
            if (isNaN(prNumber) || prNumber <= 0) {
              console.log('Invalid PR number, skipping label');
              return;
            }

            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'DEC-PENDING'
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'DEC-PENDING',
                  color: 'FBCA04',
                  description: 'DEC ìŠ¹ì¸ ëŒ€ê¸° ì¤‘'
                });
              } else {
                throw e;
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['DEC-PENDING']
            });

            const fs = require('fs');
            fs.appendFileSync(
              process.env.GITHUB_STEP_SUMMARY,
              `\n---\nðŸ·ï¸ **DEC-PENDING** ë¼ë²¨ì´ PR #${prNumber}ì— ë¶€ì°©ë˜ì—ˆìŠµë‹ˆë‹¤.\n`
            );

            const query = '${{ inputs.query }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '## ðŸ”” ìŠ¹ì¸ ì»¤ë§¨ë“œ ìƒì„±ë¨ Â· ë¡œì»¬ ì‹¤í–‰ ëŒ€ê¸°',
                '',
                `**Query**: \`${query}\``,
                '',
                'ìŠ¹ì¸ìžëŠ” Workflow Summaryì—ì„œ ë³µë¶™ìš© ì»¤ë§¨ë“œë¥¼ ë³µì‚¬í•˜ì—¬ ë¡œì»¬ì—ì„œ ì‹¤í–‰í•˜ì„¸ìš”.',
                '',
                'ìŠ¹ê²© ì™„ë£Œ í›„ ì´ PRì— `/dec approved` ì½”ë©˜íŠ¸ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”.',
                '',
                '---',
                `ðŸ”— [Workflow Run](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID})`
              ].join('\n')
            });
'@

# âœ… UTF-8 "BOM ì—†ìŒ"ìœ¼ë¡œ ì €ìž¥
$utf8NoBom = New-Object System.Text.UTF8Encoding($false)
[System.IO.File]::WriteAllText(".github\workflows\approve-dec.yml", $yml, $utf8NoBom)
