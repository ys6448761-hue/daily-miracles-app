name: Approve DEC (safe mode: draft + copy command)

on:
  workflow_dispatch:
    inputs:
      query:
        description: "검색/토론 쿼리 (필수)"
        required: true
        type: string
      decider:
        description: "승인자 이름 (기본: 푸르미르)"
        required: false
        default: "푸르미르"
        type: string
      scopes:
        description: "검색 범위 (decisions,system,execution,team,all)"
        required: false
        default: "all"
        type: string
      mode:
        description: "요약 모드 (general|decision|action)"
        required: false
        default: "decision"
        type: choice
        options:
          - general
          - decision
          - action
      k:
        description: "상위 결과 개수"
        required: false
        default: "5"
        type: string
      delete_draft:
        description: "DRAFT 생성 후 삭제(기본 false 권장)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"
      pr_number:
        description: "PR 번호 (라벨 부착용, 비워두면 라벨 생략)"
        required: false
        default: ""
        type: string

jobs:
  approve-dec:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate DEC DRAFT (no promote)
        run: |
          echo "Query=${{ inputs.query }}"
          node scripts/debate-trigger.js \
            --query "${{ inputs.query }}" \
            --scopes "${{ inputs.scopes }}" \
            --mode "${{ inputs.mode }}" \
            --k "${{ inputs.k }}" \
            --generate-dec-draft \
            --decider "${{ inputs.decider }}" \
            --log

      - name: Optionally delete drafts (best-effort)
        if: ${{ inputs.delete_draft == 'true' }}
        run: |
          rm -f docs/decisions/DEC-DRAFT-*.md || true

      - name: Write copy-friendly approve command to workflow summary
        run: |
          {
            echo "## ✅ 승인(정식 DEC 발행) 복붙용 커맨드"
            echo ""
            echo "> 아래 박스 우측 상단 **Copy** 버튼으로 복사해 로컬(토큰 보유 환경)에서 실행하세요."
            echo ""
            echo '```bash'
            echo 'DEC_PROMOTE_TOKEN=YOUR_TOKEN node scripts/debate-trigger.js \'
            echo "  --query \"${{ inputs.query }}\" \\"
            echo '  --generate-dec-draft \'
            echo '  --promote \'
            echo "  --decider \"${{ inputs.decider }}\" \\"
            echo '  --delete-draft \'
            echo '  --log'
            echo '```'
            echo ""
            echo "### 입력값"
            echo "- query: \`${{ inputs.query }}\`"
            echo "- scopes: \`${{ inputs.scopes }}\`"
            echo "- mode: \`${{ inputs.mode }}\`"
            echo "- k: \`${{ inputs.k }}\`"
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Add DEC-PENDING label to PR
        if: ${{ inputs.pr_number != '' }}
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = parseInt('${{ inputs.pr_number }}', 10);
            if (isNaN(prNumber) || prNumber <= 0) {
              console.log('Invalid PR number, skipping label');
              return;
            }

            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: 'DEC-PENDING'
              });
            } catch (e) {
              if (e.status === 404) {
                await github.rest.issues.createLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  name: 'DEC-PENDING',
                  color: 'FBCA04',
                  description: 'DEC 승인 대기 중'
                });
              } else {
                throw e;
              }
            }

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              labels: ['DEC-PENDING']
            });

            const fs = require('fs');
            fs.appendFileSync(
              process.env.GITHUB_STEP_SUMMARY,
              `\n---\n🏷️ **DEC-PENDING** 라벨이 PR #${prNumber}에 부착되었습니다.\n`
            );

            const query = '${{ inputs.query }}';

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: [
                '## 🔔 승인 커맨드 생성됨 · 로컬 실행 대기',
                '',
                `**Query**: \`${query}\``,
                '',
                '승인자는 Workflow Summary에서 복붙용 커맨드를 복사하여 로컬에서 실행하세요.',
                '',
                '승격 완료 후 이 PR에 `/dec approved` 코멘트를 남겨주세요.',
                '',
                '---',
                `🔗 [Workflow Run](${process.env.GITHUB_SERVER_URL}/${context.repo.owner}/${context.repo.repo}/actions/runs/${process.env.GITHUB_RUN_ID})`
              ].join('\n')
            });
