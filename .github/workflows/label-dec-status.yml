name: Label DEC Status (reusable)

on:
  workflow_call:
    inputs:
      pr_number:
        required: true
        type: number
      status:
        required: true
        type: string # pending | approved

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  label:
    runs-on: ubuntu-latest
    steps:
      - name: Ensure labels exist + apply status
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = Number(${{ inputs.pr_number }});
            const status = String(${{ toJson(inputs.status) }}).toLowerCase();

            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const LABEL_PENDING = { name: "DEC-PENDING", color: "FBCA04", description: "DEC 승인 대기" };
            const LABEL_APPROVED = { name: "DEC-APPROVED", color: "0E8A16", description: "DEC 승인 완료" };

            async function ensureLabel(label) {
              try {
                await github.rest.issues.getLabel({ owner, repo, name: label.name });
              } catch (e) {
                if (e.status === 404) {
                  await github.rest.issues.createLabel({
                    owner, repo,
                    name: label.name,
                    color: label.color,
                    description: label.description
                  });
                } else {
                  throw e;
                }
              }
            }

            await ensureLabel(LABEL_PENDING);
            await ensureLabel(LABEL_APPROVED);

            if (status === "pending") {
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: prNumber,
                labels: [LABEL_PENDING.name]
              });
              return;
            }

            if (status === "approved") {
              // add approved
              await github.rest.issues.addLabels({
                owner, repo,
                issue_number: prNumber,
                labels: [LABEL_APPROVED.name]
              });

              // remove pending (ignore if not present)
              try {
                await github.rest.issues.removeLabel({
                  owner, repo,
                  issue_number: prNumber,
                  name: LABEL_PENDING.name
                });
              } catch (e) {
                if (e.status !== 404) throw e;
              }
              return;
            }

            core.setFailed(`Unknown status: ${status}. Use pending|approved`);
