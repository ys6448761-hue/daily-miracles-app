name: PR DEC Report Comment

on:
  workflow_run:
    workflows: ["Nightly DEC Candidates", "Weekly DEC Candidates", "Monthly DEC Candidates (low priority)", "Manual DEC Run (ad-hoc draft + report)"]
    types:
      - completed

jobs:
  comment:
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success'

    steps:
      - name: Download artifacts from triggering workflow
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: downloaded-artifacts
        continue-on-error: true

      - name: Find and read report
        id: report
        run: |
          # Find the latest report file
          REPORT_FILE=$(find downloaded-artifacts -name "daily-dec-report-*.md" -type f | head -1)

          if [ -z "$REPORT_FILE" ]; then
            echo "No report file found"
            echo "found=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "Found report: $REPORT_FILE"
          echo "found=true" >> $GITHUB_OUTPUT

          # Read report content (limit to 65000 chars for GitHub comment limit)
          CONTENT=$(head -c 65000 "$REPORT_FILE")

          # Write to file for multiline output
          echo "$CONTENT" > report_content.md

      - name: Post comment to related PR (if exists)
        if: steps.report.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');

            // Read report content
            let reportContent = '';
            try {
              reportContent = fs.readFileSync('report_content.md', 'utf8');
            } catch (e) {
              console.log('Could not read report file');
              return;
            }

            // Get workflow run info
            const runId = context.payload.workflow_run.id;
            const runUrl = context.payload.workflow_run.html_url;
            const workflowName = context.payload.workflow_run.name;

            // Try to find associated PR
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc',
              per_page: 5
            });

            if (prs.length === 0) {
              console.log('No open PRs found');
              return;
            }

            // Post to most recent PR (or could match by branch)
            const pr = prs[0];

            const commentBody = `## ðŸ“Š DEC Report (${workflowName})

            <details>
            <summary>Click to expand report</summary>

            ${reportContent}

            </details>

            ---
            ðŸ”— [Workflow Run](${runUrl}) | ðŸ¤– Auto-generated by DEC automation
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: commentBody
            });

            console.log(`Posted comment to PR #${pr.number}`);
