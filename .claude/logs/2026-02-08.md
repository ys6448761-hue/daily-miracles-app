# 2026-02-08 작업 로그

> 작업자: Claude Code (Opus 4.6) + 푸르미르
> 브랜치: main (직접 push)

---

## 커밋 히스토리 (6건)

| # | Hash | 메시지 | 파일수 |
|---|------|--------|-------|
| 1 | `1a90a7c` | feat(ops): Slack 알림 부활 게이트 + SkillsMP 비용 가드 + Allowlist v0.1 | 9 |
| 2 | `71601c3` | fix(cta): Play 진입 CTA 버튼 텍스트 통일 "소원 체험해보기 (무료)" | 10 |
| 3 | `166269b` | ci(ail-gate): push 트리거 추가 + skillsmp-gate 검증 단계 포함 | 1 |
| 4 | `b9c2538` | chore: AIL Gate status check 연동 테스트 (빈 커밋) | 0 |
| 5 | `b41aaf9` | feat(소원그림): caption_one_liner + certificate_4to5 서비스 구현 | 5 |
| 6 | `d3829f2` | chore: 미커밋 파일 일괄 정리 (docs/scripts/inputs/config) | 9 |

---

## A. OPS / 배포 안정성

### A-1. Slack 알림 부활 게이트
- **진단**: `.env`에 Slack 환경변수 0개 → 전체 Slack 알림 중단 상태 발견
- **구현**:
  - `utils/envValidator.js` — OPS_SLACK_WEBHOOK critical 승격, 프로덕션 누락 시 exit(1)
  - `server.js` — IS_PRODUCTION 게이트 + 부팅 차단 로직
  - `services/slackHeartbeatService.js` (신규) — 매일 09:00 KST heartbeat, 이메일 폴백
  - `scripts/ops/slack-healthcheck.js` (신규) — 5단계 진단 스크립트
  - `.env.example` — OPS_SLACK_WEBHOOK "선택" → "필수(프로덕션)"
- **테스트**: 프로덕션 exit(1) 확인, 개발 환경 경고만 출력 확인
- **잔여**: Render 대시보드에서 OPS_SLACK_WEBHOOK 등록 + 재배포 필요

### A-2. SkillsMP 비용 가드
- **구현**:
  - `scripts/ops/skillsmp-gate.js` (신규) — 4-gate MCP 서버 가드
    - Gate 1: 프로덕션 금지 (exit 1)
    - Gate 2: SKILLSMP_ENABLED !== 'true' → exit 0
    - Gate 3: API 키 미설정 → exit 1
    - Gate 4: Allowlist 로드 (선택적)
  - `.claude/mcp/mcp.json` — npx 직접 실행 → gate.js 경유
  - `CLAUDE.md` — SkillsMP "기본 OFF" 정책 재작성
  - `.env.example` — SKILLSMP_ENABLED=false, MAX_RESULTS=10, MAX_CONTEXT_TOKENS=1500
- **테스트**: 3가지 시나리오(disabled/production/no-key) 모두 통과

### A-3. SKILL-ALLOWLIST v0.1
- `.claude/skills/SKILL-ALLOWLIST.json` (신규)
- 16개 스킬 → 실제 레포 모듈 매핑 완료
- 초기: LIVE 7 / PARTIAL 5 / TODO 4

### A-4. AIL Gate CI
- `.github/workflows/ail-gate.yml` — push to main 트리거 추가
- skillsmp-gate.js 검증 단계 포함, PR 체크는 pull_request에서만 실행
- 첫 실행 성공 확인 (GitHub Actions: completed/success)

---

## B. CTA 문구 통일

**목표**: 모든 Play 진입 CTA → "소원 체험해보기 (무료)"

### 변경된 파일 (10개)
| 파일 | 변경 전 | 변경 후 |
|------|--------|--------|
| `index.html` (Hero) | "문제 해결 시작하기" | 통일 + 헬퍼텍스트 |
| `index.html` (하단) | "소원 보내기" | 통일 + 헬퍼텍스트 |
| `result.html` | "🎯 새로운 기적 시작하기" | 통일 |
| `playground/index.html` | "+ 카드 만들기" | 통일 |
| `playground/result.html` | "이 카드로 만들기" | 통일 |
| `playground/share.html` | "나도 내 버전으로 만들기" | 통일 + 헬퍼텍스트 |
| `wish-tracking.html` ×2 | "새로운 소원 빌러가기/빌기" | 통일 |
| `yeosu-wish-result.html` ×2 | "새로운 소원 빌기" | 통일 |

### Play 진입 화면 "무료" 안내 추가 (3곳)
- `questions.html`, `wish-form.html`, `playground/create.html`
- 첫 줄: "지금은 무료 체험이에요. 사진 없이도 가능해요."

### 헬퍼 텍스트
- "1분이면 끝나요. 결제 없이도 구경할 수 있어요."

### 미변경 (결제 CTA)
- program.html openCheckout 버튼 3개
- result.html "프리미엄으로 업그레이드"
- program-fail.html, payment-success.html

---

## C. 소원그림 패키지 P0

### C-1. captionService (caption_one_liner)
- **파일**: `services/captionService.js` (신규)
- **모델**: gpt-4o-mini (max_tokens:100, temp:0.7)
- **입력**: `{ tone: HOPEFUL|CALM|RESTART, keywords?, locale? }`
- **출력**: `{ caption: string, safety_flags: { has_forbidden, redacted, reason? } }`
- **검증 파이프라인**:
  1. `checkForbiddenWords()` (reverseOrderPrompt.js 재사용, 67개 금지어)
  2. 보장어 정규식 (이루어집니다/확실히/반드시/100%/운명확정/당첨/보장/틀림없이/무조건)
  3. 길이(10-30자) + 이모지(≤1) + 줄바꿈 금지
- **폴백**: CALM "오늘의 기록이 조용히 쌓여가요." / HOPEFUL "좋은 방향으로 한 걸음 더." / RESTART "다시 시작해도 괜찮아요."
- **에러처리**: 3회 재시도 + 2초 백오프, 전체 실패 시 폴백 (서비스 절대 에러 안 던짐)
- **테스트**: 검증 로직 4케이스 통과, 폴백 반환 확인

### C-2. certificateService (certificate_4to5)
- **파일**: `services/certificateService.js` (신규)
- **출력**: 1024×1280 PNG (4:5 비율)
- **방식**: sharp SVG composite (DALL-E 호출 없음, 비용 0)
- **레이아웃**:
  ```
  ┌──────────────────────────────┐  0px
  │  YONGGUNG BOARDING CERTIFICATE │  타이틀 SVG
  │  입항 증명서                    │
  ├──────────────────────────────┤  140px
  │  source image (960×800)       │  소스 이미지 (cover)
  ├──────────────────────────────┤  1120px
  │  날짜    증명서ID              │  정보 밴드 SVG
  │  캡션 텍스트                   │
  │  하루하루의 기적 · Daily M.    │
  └──────────────────────────────┘  1280px
  ```
- **배경**: 브랜드 그라디언트 (#9B87F5 → #F5A7C6)
- **테스트**: 실제 wish 이미지로 생성 성공, 1024×1280 PNG 확인, 시각 검증 완료

### C-3. certificateRoutes + server.js 연결
- **파일**: `routes/certificateRoutes.js` (신규)
- **엔드포인트**:
  - `POST /api/certificate/generate` — 증명서 생성 (caption 자동 생성 지원)
  - `GET /api/certificate/list` — 증명서 목록
- **server.js**: 라우터 로딩(~line 203) + 등록(~line 1195) 추가

### SKILL-ALLOWLIST 최종 상태
| Before | After |
|--------|-------|
| LIVE 7 / PARTIAL 5 / TODO 4 | **LIVE 9 / PARTIAL 5 / TODO 2** |

승격: `caption_one_liner` TODO→LIVE, `certificate_4to5` TODO→LIVE

---

## D. 기타

### 쓰레기 파일 정리
- `tatus` (8KB) — git 오타 잔재 → 삭제
- `tore --staged .` (8KB) — git 오타 잔재 → 삭제
- `enforce OPS_SLACK_WEBHOOK...` (8KB) — git 오타 잔재 → 삭제

### 미커밋 파일 일괄 정리
- `docs/systems/` — 소원놀이터 종합문서 + 퀵레퍼런스
- `inputs/business_plan.txt`
- `ops/biddoc/config.yml`
- `scripts/fix-*.js` 4개

---

## 남은 작업

### P0 (오픈 차단)
| 작업 | 상태 | 비고 |
|------|------|------|
| Render OPS_SLACK_WEBHOOK 등록 + 재배포 | 수동 필요 | 대시보드 작업 |

### P0 (매출 영향)
| 작업 | 상태 | 비고 |
|------|------|------|
| postcard_1to1 캡션/오버레이 합성 | PARTIAL | DALL-E raw만 출력 중 |

### P1 (전환/공유 강화)
| 작업 | 상태 | 비고 |
|------|------|------|
| og_meta_builder LIVE 승격 | PARTIAL | 정적 하드코딩 → 동적 OG |
| archive_page 1스크린 구현 | TODO | 다운로드 3버튼 + 혜택 + CTA |
| retry.with_backoff 통합 유틸 | PARTIAL | 각 서비스 인라인 → 통합 |
| T+1 후속 메시지 정확 시점 발송 | PARTIAL | 고정시간 → T+1 시점 |

---

## 교훈

1. **OpenAI 클라이언트 지연 초기화 필수** — `new OpenAI()` 는 API 키 없으면 즉시 throw. 서비스 모듈 로딩 자체가 실패함. `getOpenAI()` 래퍼로 해결.
2. **sharp SVG composite 한글 폰트** — librsvg가 시스템 폰트 의존. `sans-serif` 폴백 사용. Render 배포 환경에서도 동작 확인 필요.
3. **직접 push + branch protection** — "AIL Gate" required check은 push 전에 실행 불가 → bypass 경고 불가피. PR 워크플로우 전환 시 해소.
4. **git 오타 파일** — `git tatus`, `git tore --staged .` 등 오타 실행 시 파일이 생성됨. 주기적 정리 필요.

---

*작성: 2026-02-08 23:50 KST*
